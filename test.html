<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
</head>
<body>
    <div class="container  mt-5" style="border:1px solid steelblue;">

        <div class="row">
            <div class="col-12 mt-3">
                <div class="input-group mb-3" >
                    <button class="btn btn-primary" type="button" id="add_user"><i class="bi bi-person-plus-fill"></i></button>
                    <input type="text" class="form-control me-3" id="user_name" placeholder="請輸入姓名">
                </div>
            </div>
        </div>

        <hr>

        <div class="row" id="user_block">
            <!-- append -->
        </div>

        <div class="row">
            <div class="col-12 mt-3">
                <div class="input-group mb-3">
                    <button class="btn btn-outline-secondary" type="button" id="add_list"><i class="bi bi-plus-lg"></i></button>
                    <select class="form-select" id="user_select">
                        <option selected disabled>請選擇代墊付款人</option>
                      </select>
                    <input type="text" class="form-control me-5" id="item_list" placeholder="請輸入花費項目"> 
                    <span class="input-group-text">NT$</span>
                    <input type="text" class="form-control" id="cost" placeholder="" >
                </div>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-12 mb-3">
                <ul id="cost_list" class="list-group list-group-numbered">
                </ul>
            </div>
        </div>


        <!-- <hr> -->

        <button class="btn btn-outline-danger my-4" type="button" id="Checkout">結帳</button>
        <div class="row">
            <div class="col-12">
                <p id="total_cost"></p>
                <p id="avg_cost"></p>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
               <p id="qq"></p>
               <p id="ee"></p>
            </div>
        </div>
    </div>


    
</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function(){
        var user_arr = [];
        var user_count = 0;
        var cost_total = 0 ;

        // 新增user
        $('#add_user').click(function(){
            var user_name = $('#user_name').val()
            $('#user_block').append(
                `
                <div class="col mt-3" id=${user_count}>
                    <div class="input-group ">
                        <span class="btn btn-danger" id="del_${user_count}"><i class="bi bi-dash-lg"></i></span>
                        <input type="text" class="form-control me-3" value= ${user_name} disabled>
                    </div>
                </div>
                `
            )
            // 下拉選單新增選項
            $('#user_select').append(
                `
                <option value="${user_count}">${user_name}</option>
                `
            )
            user_arr.push({
                id:user_count,
                name:user_name,
                cost:0,
                give_someone :[]
            })
            
            for(let i = 0 ; i < user_arr.length ; i++){
                user_arr[i].give_someone = set_give_someone(user_arr.length, user_arr)
            }

            $('#user_name').val('')
            console.log('確認一下',user_arr);
            
            // 刪除
            $(`#del_${user_count}`).click(function(){
                
                var delete_id = $(this).attr('id')
                console.log(delete_id);
                user_arr.splice(delete_id,1)
                $(this).remove();
                // console.log("現在剩下",user_arr);
            })
            user_count++;
            store_user_data(user_arr);
        })

        



        // 新增項目
        $('#add_list').click(function(){
            var cost = Number( $('#cost').val() )
            var item_list = $('#item_list').val()
            var selete_user = $('#user_select').val()
            // console.log("你選到",selete_user);
            $('#cost_list').append(`<li class='list-group-item'>${user_arr[selete_user].name} - ${item_list} - NT$${cost}</li>`)
            cost_total += cost //總金額
            user_arr[selete_user].cost+=cost;//個人帳戶金額
            $('#item_list,#cost').val("")
            $("#total_cost").text('').append(`總共花費 : ${cost_total}`)

            // for(let i = 0 ; i < user_arr.length; i++ ){
                // if( i !== selete_user ){
                //     user_arr[i].give_someone[i].give_cost += cost/user_count 
                // }
                set_give_cost(user_arr,selete_user,cost)
            // }
            store_user_data(user_arr);
            console.log("我新增一筆",user_arr);
        })

        // 結帳
        $('#Checkout').click(function(){
            console.log('取得資料:' ,get_user_data())
            var user_total = $('#user_total').val()
            var avg_cost = cost_total /user_count ;
            $("#avg_cost").text("").append(`平均每人 : ${avg_cost}`)
            $("#qq").text('')
            for(let i= 0 ; i< get_user_data().length ;i++){
                $("#qq").append(`${get_user_data()[i].name} - ${get_user_data()[i].cost} <br>` )
                for(let j = 0 ; j < get_user_data()[i].give_someone.length ;j++){
                    if(i !== get_user_data()[i].give_someone[j].user_id){
                        $("#qq").append(`現在是 ${get_user_data()[i].name}- 需要給 ${get_user_data()[i].give_someone[j].user_name} - ${get_user_data()[i].give_someone[j].give_cost} <br>`)
                    }
                }
                $("#qq").append(`<hr>`)
            }
        })
    })

    // 取得目前的give someont
    function get_give_someone(){
        
    }

    function store_user_data(user_arr){
        var user_arr_str = JSON.stringify(user_arr)
        sessionStorage.setItem("user_arr", user_arr_str);
    }

    function get_user_data(){
        return JSON.parse(sessionStorage.getItem("user_arr"));
    }


    function set_give_someone(use_number, user_arr){
            var result=[]
            for(var i=0;i<use_number;i++){
                result.push({user_id: user_arr[i].id,user_name:user_arr[i].name ,give_cost:0})
            }
            return result
        }
    function set_give_cost(user_arr,selete_user,cost){
        // console.log("set_give_cost",cost);
        for(let i= 0 ;i<user_arr.length; i++){
            user_arr[i].give_someone[selete_user].give_cost+= cost/user_arr.length;
        }
    }

</script>