<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="分帳好幫手！算錢、分帳一鍵完成，懶人分帳，快速計算，出遊、開趴免煩惱!">
    </head>
    <title>分帳好幫手！算錢、分帳一鍵完成，懶人分帳，快速計算，出遊、開趴免煩惱!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-X8F064BFGZ"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-X8F064BFGZ');
        </script>
</head>

<style>
    .hide{
        display: none;
    }
    h1.h1 {
        font-size: 32px;
    }
    .btn-success.no-pointer {
        cursor:auto;
    }
</style>

<body>
    <!-- <div class="alert alert-danger user_alert" role="alert">
        分帳人不可為空！
      </div> -->
    <nav class="navbar navbar-light bg-dark">
        <h1 class="navbar-brand mb-0 text-light h1 px-4">分帳好幫手！算錢、分帳一鍵完成，懶人分帳，快速計算，出遊、開趴免煩惱!</h1>
      </nav>
    <div class="container  mt-5">

        <div class="row">
            <div class="col-12">
                <div class="input-group mb-3" >
                    <span class="input-group-text" id="addon-wrapping"><i class="bi bi-person-circle"></i></span>
                    <input alt="要參與分帳的人" type="text" class="form-control" id="user_name" placeholder="請輸入參與分帳人姓名">
                    <button class="btn btn-primary" type="button" id="add_user"><i class="bi bi-person-plus-fill"></i></button>
                </div>
            </div>
        </div>

        <hr>

        <div class="row mb-4" id="user_block">
            <!-- append -->
        </div>

        <div class="row">
            <div class="col-12 col-md-4 mt-3">
                <div class="input-group mb-3">
                    <!-- <button class="btn btn-outline-secondary" type="button" id="add_list"><i class="bi bi-plus-lg"></i></button> -->
                    <label class="btn btn-success no-pointer">代墊付款人</label>
                    <select class="form-select" id="user_select">
                        <option selected disabled>請選擇代墊付款人</option>
                    </select>
                    <!-- <button type="button" class="btn btn-secondary" id="add_list"><i class="bi bi-plus"></i></button> -->
                </div>
            </div>
            <div class="col-7 col-md-4 mt-3">
                <div class="input-group mb-3">
                    <label class="btn btn-success no-pointer">請輸入花費項目</label>
                    <input alt="分帳項目" type="text" class="form-control me-5" id="item_list" placeholder="請輸入花費項目">
                </div>
            </div>
            <div class="col-5  col-md-4 mt-3">
                <div class="input-group mb-3">
                    <label class="btn btn-success no-pointer">請輸入金額</label>
                    <span class="input-group-text">NT$</span>
                    <input alt="分帳金額" type="text" class="form-control" id="cost" placeholder="" >
                    <button type="button" class="btn btn-secondary" id="add_list"><i class="bi bi-plus"></i></button>
                </div> 
            </div>
            <div class="col-12 mt-3" id="pay_share">
                <label class="btn btn-success no-pointer">分攤人員: </label>
                <div class="form-check hide form-switch mx-3" id="switch_all_block">
                    <input alt="大家一起均分" class="form-check-input" type="checkbox" id="switch_all">
                    <label class="form-check-label " for="switch_all">全選</label>
                </div>
                <!-- <div class="form-check form-switch mx-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                    <label class="form-check-label" for="flexSwitchCheckDefault">Default switch checkbox input</label>
                </div> -->
            </div>    
        </div>

        <hr>

        <div class="row">
            <div class="col-12 mb-3">
                <ul id="cost_list" class="list-group list-group-numbered">
                    <!-- append -->
                </ul>
            </div>
        </div>


        <!-- <hr> -->

        <button class="btn btn-outline-danger my-4" type="button" id="Checkout" disabled >結帳</button>
        <div class="row">
            <div class="col-12">
                <p id="total_cost"></p>
                <p id="avg_cost"></p>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
               <p id="pay_someone_block"></p>
            </div>
        </div>

    </div>
    
    <!-- Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="errorModalLabel">輸入錯誤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            ...
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
        </div>
    </div>
    
</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function(){
        sessionStorage.setItem("user_arr", "[]");
        sessionStorage.setItem("user_count", "0");
        sessionStorage.setItem("cost_total", "0");
        // var user_arr = [];
        var user_count = Number(sessionStorage.getItem("user_count"));
        // var cost_total = 0 ;

        // 新增user
        $('#add_user').click(function(){
            if($('#user_name').val() == ''){
                alert('分帳人不可為空')
                return
            }
            add_user_data(user_count)
            render(user_count)  // 渲染畫面

            // 刪除
            delete_user(user_count)

            user_count++;
            sessionStorage.setItem("user_count", `${user_count}`);
        })
        $('#user_name').on('keypress', function(e){
            if (e.keyCode == 13) {
                if($('#user_name').val() == ''){
                    alert('分帳人不可為空')
                    return
                }
                add_user_data(user_count)
                render(user_count)  // 渲染畫面
    
                // 刪除
                delete_user(user_count)
    
                user_count++;
                sessionStorage.setItem("user_count", `${user_count}`);
            }
        })

        // 新增項目
        add_item()

        // 結帳
        checkout()
        
        // 全選
        switch_all()

        // unlock checkout
        unlock_checkout()

        //分攤人員 switch
        // share_switch_change()    
    })
    // 結帳
    function checkout(){
        $('#Checkout').click(function(){
            var user_arr = get_user_data();
            var cost_total =  Number(sessionStorage.getItem("cost_total"));
            var user_count = Number(sessionStorage.getItem("user_count"));
            // console.log('取得資料:' ,get_user_data())
            var user_total = $('#user_total').val()
            var avg_cost = cost_total /user_count ;
            $("#avg_cost").text("").append(`平均每人 : ${avg_cost}`)
            $("#pay_someone_block").text('')
            for(let i= 0 ; i< get_user_data().length ;i++){
                $("#pay_someone_block").append(`${get_user_data()[i].name} 總共代墊 : ${get_user_data()[i].cost} 元<br>` )
                for(let j = 0 ; j < get_user_data()[i].give_someone.length ;j++){
                    if(i !== get_user_data()[i].give_someone[j].user_id){
                        $("#pay_someone_block").append(`---- 需要給 ${get_user_data()[i].give_someone[j].user_name} - ${get_user_data()[i].give_someone[j].give_cost} <br>`)
                    }
                }
                $("#pay_someone_block").append(`<hr>`)
            }
        })
    }
    // 新增項目
    function add_item(){
        $('#add_list').click(function(){
            var cost_total =  Number(sessionStorage.getItem("cost_total"));
            var user_arr = get_user_data()
            var cost = Number( $('#cost').val() )
            // console.log(cost);
            var item_list = $('#item_list').val()
            var selete_user = $('#user_select').val()
            var switch_user = $('.form-switch')
            var share_uesr = [];
            for(let i = 0 ; i < switch_user.length ; i++){
               if(switch_user[i].children[0].checked){
                share_uesr.push(switch_user[i])
               }
            }
            var share_str ='';
            for(let i = 0 ; i < share_uesr.length ; i++ ){
                share_str += `[ ${share_uesr[i].innerText} ]`
                if(i!= share_uesr.length-1){
                    share_str += ` , `
                }
            }

            if( cost <= 0 || isNaN(cost)){
               var err_msg='請檢查 金額欄位 是否輸入正確資料'
                call_modal(err_msg)
            }else if(share_uesr.length == 0){
                var err_msg='請檢查 分攤人員 是否 勾選'
                call_modal(err_msg)
            }else{
                // console.log("你選到",selete_user);
                var findIndex = user_arr.findIndex(item => item.id == selete_user)
                // console.log(findIndex);
                $('#cost_list').append(`<li class='list-group-item'>${user_arr[findIndex].name} - ${item_list} - NT$${cost} ===> 分攤人員有 : ${share_str}</li> `)
                cost_total += cost //總金額
                user_arr[findIndex].cost+=cost;//個人帳戶金額
                $('#item_list,#cost').val("")
                $("#total_cost").text('').append(`總共花費 : ${cost_total}`)
    
                // set_give_cost(user_arr,selete_user,cost)
                set_give_cost_new(user_arr,selete_user,cost,share_uesr)
                store_user_data(user_arr);
                // console.log("我新增一筆",user_arr);
    
                // 按下結帳後,再新增項目時,先把結帳資訊清空
                $("#pay_someone_block,#avg_cost").text('')
                unlock_checkout()

                sessionStorage.setItem("cost_total", JSON.stringify(cost_total));
            }
        })
    }
    // 刪除項目
    function delete_user(user_count){
        $(`#${user_count}`).click(function(){
            var user_arr = get_user_data()
            var delete_id = $(this).attr('id')
            console.log('我點到誰',delete_id);
            for(let i= 0 ; i < user_arr.length ;i++ ){
                if(user_arr[i].id == delete_id){
                    user_arr.splice(i,1)
                }
            }
            $(this).closest(`#del_${delete_id}`).remove();
            $(`#user_select option[value=${delete_id}]`).remove()
            console.log("現在剩下",user_arr);
            store_user_data(user_arr);
            })
    }

    // 更新使用者資料
    function add_user_data(user_count){
        var user_name = $('#user_name').val()
        var user_arr = get_user_data();
        user_arr.push({
                id:user_count,
                name:user_name,
                cost:0,
                give_someone :[]
            })
            store_user_data(user_arr);

            for(let i = 0 ; i < user_arr.length ; i++){
                if(i == user_arr.length-1){
                    user_arr[i].give_someone = set_give_someone(user_arr.length, user_arr)
                }
                else{
                    user_arr[i].give_someone.push({user_id: user_count,user_name:user_name ,give_cost:0})
                }
            }
            store_user_data(user_arr);
            console.log("我新增囉",user_arr);
    }
    
    // 渲染畫面
    function render(user_count){
        var user_name = $('#user_name').val()
        $('#user_block').append(
            `
            <div class="col-6 col-md-4 mt-3" id=del_${user_count}>
                <div class="input-group ">
                    <span class="btn btn-danger" id="${user_count}"><i class="bi bi-dash-lg"></i></span>
                    <input type="text" class="form-control me-3" value= ${user_name} disabled>
                </div>
            </div>
            `
        )
        // 下拉選單新增選項
        $('#user_select').append(
            `
            <option value="${user_count}">${user_name}</option>
            `
        )
        // 清空輸入框
        $('#user_name').val('')

       

        // share switch
        $('#pay_share').append(
            `
            <div class="form-check form-switch mx-3" id=Switch_${user_count}>
                    <input class="form-check-input" type="checkbox" role="switch" id="Switch_${user_name}">
                    <label class="form-check-label" for="Switch_${user_name}">${user_name}</label>
            </div>            
            `
        )
        // switch_all 
        var  findCheckbox = $('.form-switch');
        if(findCheckbox.length>=2){
            $('#switch_all_block').removeClass('hide')
        }
        
        // switch change
        switch_change()
    }

    function store_user_data(user_arr){
        var user_arr_str = JSON.stringify(user_arr)
        sessionStorage.setItem("user_arr", user_arr_str);
    }

    function get_user_data(){
        return JSON.parse(sessionStorage.getItem("user_arr"));
    }

    function set_give_someone(use_number, user_arr){
            var result=[]            
            for(var i=0;i<use_number;i++){
                result.push({user_id: user_arr[i].id,user_name:user_arr[i].name ,give_cost:0})
            }
            return result
        }
    // function set_give_cost(user_arr,selete_user,cost){
    //     // console.log("set_give_cost",cost);
    //     for(let i= 0 ;i<user_arr.length; i++){
    //         user_arr[i].give_someone[selete_user].give_cost+= cost/user_arr.length;
    //     }
    // }

    function set_give_cost_new(user_arr,selete_user,cost,share_uesr){
        for(let i = 0 ; i < share_uesr.length ; i++){
            for(let j = 0; j < user_arr.length ; j++ ){
                if(share_uesr[i].innerText == user_arr[j].name){
                    user_arr[j].give_someone[selete_user].give_cost+= cost/share_uesr.length;
                }
            }
        }
    }


    // function share_switch_change(){
    //     $("#user_select").change(function(){
    //         var selete_user = $('#user_select').val()
    //         // console.log("你選到",selete_user);
    //         var  findCheckbox = $('.form-switch');
    //         [].forEach.call(findCheckbox,function(item,i){
    //             if(item.id == `Switch_${selete_user}`){ 
    //                 $(`#Switch_${selete_user}`).addClass("hide")
    //             }
    //             else{
    //                 $(`#Switch_${i}`).removeClass("hide")
    //             }
    //         })
    //     })
    // }
    function switch_all(){
        $('#switch_all').click(function(){
            var status = $('#switch_all').prop('checked');
            // console.log(status);
            var  findCheckbox = $('.form-switch input');
            if(status){
                findCheckbox.prop('checked',true)
            }else{
                findCheckbox.prop('checked',false)
            }
        })
    }

    
    function switch_change(){
        $('input[role=switch]').off('click').click(function(){
            var current_switch = $('input[role=switch]');
            var status = [];
            for(let i = 0 ; i < current_switch.length ; i++){
               if(current_switch[i].checked){
                status.push(current_switch[i])
               }
            }
            if(status.length == current_switch.length){
                $('#switch_all').prop('checked',true)
            }
            else{
                $('#switch_all').prop('checked',false);
            }
        })
    }

    function call_modal(err_msg){
        $('.modal-body').text('').append(err_msg)
        $('#errorModal').modal('show')
    }

    function unlock_checkout(){
        var list_count = $('#cost_list li')
        if(list_count.length == 1){
            $('#Checkout').removeAttr('disabled')
        }
    }

</script>